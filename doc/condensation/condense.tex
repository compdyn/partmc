\documentclass{article}
\usepackage{amsmath}
\usepackage[margin=2cm]{geometry}
\usepackage{longtable}

\begin{document}

\section{Symbol list}
\label{sec:symbol-list}

\newcommand{\rr}{\raggedright}
\newcommand{\tn}{\tabularnewline\hline}
\renewcommand{\arraystretch}{1.5}
\begin{longtable}{|l|p{5.5cm}|l|l|p{4.5cm}|}
\hline \textbf{Symbol} & \textbf{Meaning}                                                       & \textbf{Type} & \textbf{Units}                        &  \textbf{Reference}                                \tn
\hline \endhead
$a$                    & \rr species index                                                      & index         & discrete                              &                                                    \tn
$\alpha$               & \rr thermal accommodation coefficient                                  & constant      & $1$                                   & \rr \verb+const%accom_coeff+, S\&P 15.76           \tn
$a_{{\rm w},i}$        & \rr water activity of particle $i$                                     & function      & $1$                                   & \rr eq.~\ref{eq:aw}                                \tn
$c_{\rm p}$            & \rr specific heat capacity of air at constant pressure                 & constant      & $\rm J \, kg^{-1}$                    & \rr \verb+const%air_spec_heat+                     \tn
$D_{\rm v}$            & \rr diffusivity coefficient                                            & function      & $\rm m^2 \, s^{-1}$                   & \rr eq.~\ref{eq:diff_ko}, S\&P 15.65               \tn
$D_{\rm v}'$           & \rr corrected diffusivity coefficient                                  & function      & $\rm m^2 \, s^{-1}$                   & \rr eq.~\ref{eq:diff_ko_corr}, S\&P 15.66          \tn
$D_{i,\rm dry}$        & \rr dry diameter of particle $i$                                       & function      & $\rm m$                               & \rr eq.~\ref{eq:D_dry}                             \tn
$D_i$                  & \rr diameter of particle $i$                                           & dynamic       & $\rm m$                               & \rr                                                \tn
$\dot{D}_i$            & \rr rate of change of $D_i$                                            & function      & $\rm m \, s^{-1}$                     & \rr eq.~\ref{eq:Ddot}                              \tn
$\delta_i^*$           & \rr growth parameter of particle $i$                                   & function      & $1$                                   & \rr eq.~\ref{eq:delta_star}                        \tn
$g_i$                  & \rr equilibriation function of particle $i$                            & function      & $\rm J \, m^{-1} \, s^{-1} \, K^{-1}$ & \rr eq.~\ref{eq:g}                                 \tn
$H$                    & \rr environmental relative humidity                                    & dynamic       & $1$                                   &                                                    \tn
$\dot{H}$              & \rr rate of change of $H$                                              & function      & $\rm s^{-1}$                          & \rr eq.~\ref{eq:Hdot}                              \tn
$\dot{H}_i$            & \rr rate of change of $H$ due to particle $i$                          & function      & $\rm s^{-1}$                          & \rr eq.~\ref{eq:Hdot_i}                            \tn
$\dot{H}_{\rm env}$    & \rr rate of change of $H$ due to environment changes                   & function      & $\rm s^{-1}$                          & \rr eq.~\ref{eq:Hdot_env}                          \tn
$\Delta H_{\rm v}$     & \rr latent heat of vaporization of water                               & constant      & $\rm J \, kg^{-1}$                    & \rr \verb+const%water_latent_heat+, S\&P 15.3      \tn
$h_i$                  & \rr growth rate function of particle $i$                               & function      & $\rm J \, m^{-1} \, s^{-1} \, K^{-1}$ & \rr eq.~\ref{eq:h} and eq.~\ref{eq:h_out_of_range} \tn
$i$                    & \rr particle index                                                     & index         & discrete                              &                                                    \tn
$\kappa_a$             & \rr hygroscopicity of species $a$                                      & function      & $1$                                   & \rr eq.~\ref{eq:kappa_indiv}                       \tn
$\kappa_i$             & \rr hygroscopicity of particle $i$                                     & function      & $1$                                   & \rr eq.~\ref{eq:kappa}                             \tn
$k_{\rm a}$            & \rr thermal conductivity of air                                        & function      & $\rm J \, m^{-1} \, s^{-1} \, K^{-1}$ & \rr eq.~\ref{eq:therm_cond}, S\&P 15.75            \tn
$k_{\rm a}'$           & \rr corrected thermal conductivity of air                              & function      & $\rm J \, m^{-1} \, s^{-1} \, K^{-1}$ & \rr eq.~\ref{eq:therm_cond_corr}, S\&P 15.76       \tn
$M_{\rm air}$          & \rr molecular weight of air                                            & constant      & $\rm kg \,mol^{-1}$                   & \rr \verb+const%air_molec_weight+                  \tn
$M_{\rm w}$            & \rr molecular weight of water                                          & constant      & $\rm kg \, mol^{-1}$                  & \rr \verb+const%water_molec_weight+                \tn
$M_a$                  & \rr molecular weight of species $a$                                    & constant      & $\rm kg \, mol^{-1}$                  & \rr \verb+aero_data%molec_weight(a)+               \tn
$m_{\rm w}$            & \rr mass of water vapor in volume $V_{\rm comp}$                       & function      & $\rm kg$                              & \rr eq.~\ref{eq:H_m_w}                             \tn
$N$                    & \rr number of particles                                                & input         & discrete                              &                                                    \tn
$P^0$                  & \rr saturation vapor pressure                                          & function      & $\rm Pa$                              & \rr eq.~\ref{eq:sat_vap}                           \tn
$p_0$                  & \rr standard surface pressure                                          & constant      & $\rm Pa$                              & \rr \verb+const%air_std_press+                     \tn
$p$                    & \rr environmental air pressure                                         & input         & $\rm Pa$                              & \rr \verb+env_state%pressure+                      \tn
$R$                    & \rr universal gas constant                                             & constant      & $\rm J \, mol^{-1} \, K^{-1}$         & \rr \verb+const%univ_gas_const+                    \tn
$\rho_{\rm w}$         & \rr density of water                                                   & constant      & $\rm kg \, m^{-3}$                    & \rr \verb+const%water_density+                     \tn
$\rho_a$               & \rr density of species $a$                                             & constant      & $\rm kg \, m^{-3}$                    & \rr \verb+aero_data%density(a)+                    \tn
$\rho_{\rm air}$       & \rr air density                                                        & function      & $\rm kg \, m^{-3}$                    & \rr eq.~\ref{eq:rho_air}                           \tn
$\sigma_{\rm w}$       & \rr surface tension (or surface energy) of water                       & constant      & $\rm J \, m^{-2}$                     & \rr \verb+const%water_surf_eng+, S\&P 15.5         \tn
$T_0$                  & \rr initial environmental temperature                                  & input         & $\rm K$                               & \rr \verb+env_state%temp+                          \tn
$T$                    & \rr current environmental temperature                                  & prescribed    & $\rm K$                               &                                                    \tn
$U$                    & \rr                                                                    & function      & $\rm J \, m^{-3} \, K^{-1}$           & \rr eq.~\ref{eq:fcn_U}                             \tn
$V$                    & \rr                                                                    & function      & $\rm s^{-1}$                          & \rr eq.~\ref{eq:fcn_V}                             \tn
$V_{i,\rm dry}^a$      & \rr dry volume of species $a$ in particle $i$                          & input         & $\rm m^3$                             & \rr \verb+aero_particle%vol(a)+                    \tn
$V_{i,\rm dry}$        & \rr dry volume of particle $i$                                         & function      & $\rm m^3$                             & \rr eq.~\ref{eq:V_dry}                             \tn
$V_{\rm comp,0}$       & \rr initial computational volume at temperature $T_0$ and pressure $p_0$  & input         & $\rm m^3$                             & \rr \verb+env_state%comp_vol+                      \tn
$V_{\rm comp}$         & \rr current computational volume                                       & function      & $\rm m^3$                             & \rr eq.~\ref{eq:comp_vol}                          \tn
$V_{i,\rm comp,0}$     & \rr initial computational volume for particle $i$ at temperature $T_0$ and pressure $p_0$ & input         & $\rm m^3$                             &                                                    \tn
$V_{i,\rm comp}$       & \rr current computational volume for particle $i$                      & function      & $\rm m^3$                             & \rr eq.~\ref{eq:comp_vol_i}                        \tn
$W$                    & \rr                                                                    & function      & $1$                                   & \rr eq.~\ref{eq:fcn_W}                             \tn
$X$                    & \rr                                                                    & function      & $\rm m$                               & \rr eq.~\ref{eq:fcn_X}                             \tn
$Y$                    & \rr                                                                    & function      & $\rm m$                               & \rr eq.~\ref{eq:fcn_Y}                             \tn
$Z$                    & \rr                                                                    & function      & $\rm m$                               & \rr eq.~\ref{eq:fcn_Z}                             \tn
\end{longtable}

\section{Equations}
\label{sec:equations}

\begin{align}
  P^0(T) &= 611.2 \exp\biggl(7.45 \ln(10)\frac{T-273.15}{T-38}\biggr) \label{eq:sat_vap} \displaybreak[0] \\
  \frac{\partial P^0}{\partial T}(T) &= P^0(T) 7.45 \ln(10)\frac{273.15 - 38}{(T-38)^2} \displaybreak[0] \\
  \rho_{\rm  air}(T,p) &= M_{\rm air} \frac{p}{R T} \label{eq:rho_air} \displaybreak[0] \\
  U(T) &= \frac{\Delta H_{\rm v} \rho_{\rm w}}{4 T} \label{eq:fcn_U} \displaybreak[0] \\
  V(T) &= \frac{4 M_{\rm w} P^{\rm 0}(T)}{\rho_{\rm w} R T} \label{eq:fcn_V} \displaybreak[0] \\
  \frac{\partial V}{\partial T}(T) &= \biggl( \frac{1}{P^{\rm 0}(T)} \frac{\partial P^{\rm 0}}{\partial T}(T)
  - \frac{1}{T} \biggr) V(T) \displaybreak[0] \\
  W(T) &= \frac{\Delta H_{\rm v} M_{\rm w}}{R T} \label{eq:fcn_W} \displaybreak[0] \\
  X(T) &= \frac{4 M_{\rm w}\sigma_{\rm w}}{R T \rho_{\rm w}} \label{eq:fcn_X} \displaybreak[0] \\
  Y(T,p) &= \frac{2 k_{\rm a}}{\alpha \rho_{\rm air}(T,p) c_{\rm p}} \sqrt{\frac{2 \pi M_{\rm air}}{R T}} \label{eq:fcn_Y} \displaybreak[0] \\
  Z(T,p) &= \frac{2 D_{\rm v}}{\alpha} \sqrt{\frac{2 \pi M_{\rm w}}{R T}} \label{eq:fcn_Z} \displaybreak[0] \\
  V_{\rm comp}(T,p) &= \frac{T}{T_0} \frac{p_0}{p} V_{\rm comp,0} \label{eq:comp_vol} \displaybreak[0] \\
  \frac{\partial V_{\rm comp}}{\partial T}(T,p) &= \frac{p_0}{p}\frac{V_{\rm comp,0}}{T_0} \displaybreak[0] \\
  &= \frac{V_{\rm comp}}{T} \displaybreak[0] \\
  \frac{\partial V_{\rm comp}}{\partial p}(T,p) &= -\frac{T}{T_0}\frac{p_0 }{p^2} V_{\rm comp,0} \displaybreak[0] \\
  &= -\frac{V_{\rm comp}}{p} \displaybreak[0] \\
  V_{i,\rm comp}(T,p) &= \frac{T}{T_0} \frac{p_0}{p} V_{i,\rm comp,0} \label{eq:comp_vol_i} \displaybreak[0] \\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  k_{\rm a} &= 10^{-3} (4.39 + 0.071  T) \label{eq:therm_cond} \displaybreak[0] \\
  k_{\rm a}'(D_i) &= \frac{k_{\rm a}}{1 + Y / D_i} \label{eq:therm_cond_corr} \displaybreak[0] \\
  \frac{\partial k_{\rm a}'}{\partial D_i}(D_i) &= \frac{k_{\rm a} Y}{(D_i+Y)^2} \displaybreak[0] \\
  D_{\rm v} &= \frac{0.211 \times 10^{-4}}{p / p_0} \left(\frac{T}{273}\right)^{1.94} \label{eq:diff_ko} \displaybreak[0] \\
  D_{\rm v}'(D_i) &= \frac{D_{\rm v}}{1 + Z / D_i} \label{eq:diff_ko_corr} \displaybreak[0] \\
  \frac{\partial D_{\rm v}'}{\partial D_i}(D_i) &= \frac{D_{\rm v} Z}{(D_i+Z)^2} \displaybreak[0] \\
  V_{i,\rm dry} &= \sum_a V_{i,\rm dry}^a \label{eq:V_dry} \displaybreak[0] \\
  D_{i,\rm dry} &= \left(\frac{6}{\pi} V_{i,\rm dry}\right)^{\frac{1}{3}} \label{eq:D_dry} \displaybreak[0] \\
   \kappa^a &= \frac{M_{\rm w} \rho_{a}}{M_{a}  \rho_{\rm w}} \qquad \text{assuming number of ions per dissociation is 1} \label{eq:kappa_indiv} \displaybreak[0] \\
   \kappa_i &= \sum_a \kappa^a \frac{V_{i,\rm dry}^a}{V_{i,\rm dry}} \label{eq:kappa} \displaybreak[0] \\
  a_{{\rm w},i}(D_i) &= \frac{D_i^3 - D_{i,\rm dry}^3}{D_i^3 + (\kappa_i - 1) D_{i,\rm dry}^3} \label{eq:aw} \displaybreak[0] \\
  \frac{\partial a_{{\rm w},i}}{\partial D_i}(D_i) &= \frac{3 D_i^2 \kappa_i D_{i,\rm dry}^3}{(D_i^3 + (\kappa_i - 1) D_{i,\rm dry}^3)^2} \displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    h_i(\delta, D_i, H) &= k_{\rm a}'(D_i) \delta
  - U V D_{\rm v}'(D_i) \Biggl(H - \biggl(\frac{1}{1+\delta}\biggr)
  a_{{\rm w},i}(D_i)
  \exp\biggl(W \frac{\delta}{1+\delta} + \frac{X}{D_i} \frac{1}{1+\delta}\biggr) \Biggr) \label{eq:h} \displaybreak[0] \\
  \frac{\partial h_i}{\partial \delta}(\delta, D_i, H) &= k_{\rm a}'(D_i) -
  \frac{U V D_{\rm v}'(D_i) a_{{\rm w},i}(D_i)}{(1 + \delta)^2} \Biggl( 1 - W \frac{1}{1+\delta}
  + \frac{X}{D_i} \frac{1}{1+\delta} \Biggr) \exp{\Biggl(W \frac{\delta}{1+\delta} +
      \frac{X}{D_i} \frac{1}{1+\delta}\Biggr)} \displaybreak[0] \\
  \frac{\partial h_i}{\partial D_i}(\delta, D_i, H) &=
  \frac{\partial k_{\rm a}'}{\partial D_i}(D_i) \delta
  - U V \frac{\partial D_{\rm v}'}{\partial D_i}(D_i) H \nonumber \\
  &\quad + U V \Biggl( a_{{\rm w},i}(D_i) \frac{\partial D_{\rm v}'(D_i)}{\partial D_i}+ D_{\rm v}'(D_i) \frac{\partial a_{{\rm w},i}}{\partial D_i}(D_i) 
  - D_{\rm v}'(D_i) a_{{\rm w},i}(D_i) \frac{X}{D_i^2} \frac{1}{1 + \delta} \Biggr) \nonumber \\
  &\quad \times \Biggl(\frac{1}{1+\delta}\Biggr)
  \exp{\Biggl(W \frac{\delta}{1+\delta} + \frac{X}{D_i} \frac{1}{1+\delta}\Biggr)} \displaybreak[0] \\
  \frac{\partial h_i}{\partial H}(\delta, D_i, H) &= - U V D_{\rm v}'(D_i) \displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  0 &= h_i(\delta_i^*(D_i,H), D_i, H) \label{eq:delta_star} \displaybreak[0] \\
  0 &= \frac{d}{d D_i} h_i(\delta_i^*(D_i,H), D_i, H)
  = \frac{\partial h_i}{\partial \delta}(\delta_i^*(D_i,H), D_i, H)
  \frac{\partial \delta_i^*}{\partial D_i}(D_i,H)
  + \frac{\partial h_i}{\partial D_i}(\delta_i^*(D_i,H), D_i, H) \displaybreak[0] \\
  0 &= \frac{d}{d H} h_i(\delta_i^*(D_i,H), D_i, H)
  = \frac{\partial h_i}{\partial \delta}(\delta_i^*(D_i,H), D_i, H)
  \frac{\partial \delta_i^*}{\partial H}(D_i,H)
  + \frac{\partial h_i}{\partial H}(\delta_i^*(D_i,H), D_i, H) \displaybreak[0] \\
  \frac{\partial \delta_i^*}{\partial D_i}(D_i,H)
  &= - \frac{\frac{\partial h_i}{\partial D_i}(\delta_i^*(D_i,H), D_i, H)}{\frac{\partial h_i}{\partial \delta}(\delta_i^*(D_i,H), D_i, H)} \displaybreak[0] \\
  \frac{\partial \delta_i^*}{\partial H}(D_i,H)
  &= - \frac{\frac{\partial h_i}{\partial H}(\delta_i^*(D_i,H), D_i, H)}{\frac{\partial h_i}{\partial \delta}(\delta_i^*(D_i,H), D_i, H)} \displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \dot{D}_i(D_i, H) &= \frac{k_{\rm a}'(D_i) \delta_i^*(D_i,H)}{U D_i} \label{eq:Ddot} \displaybreak[0] \\
  \frac{\partial \dot{D}_i}{\partial D_i}(D_i, H) &=
  \frac{1}{U D_i} 
  \frac{\partial k_{\rm a}'}{\partial D_i}(D_i) \delta_i^*(D_i, H)
  + \frac{1}{U D_i} k_{\rm a}'(D_i) \frac{\partial \delta_i^*}{\partial D_i}(D_i, H)
  - \frac{1}{U D_i^2} k_{\rm a}'(D_i) \delta_i^*(D_i, H) \displaybreak[0] \\
  \frac{\partial \dot{D}_i}{\partial H}(D_i, H) &=
  \frac{k_{\rm a}'(D_i)}{U D_i} 
  \frac{\partial \delta_i^*}{\partial H}(D_i, H) \displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \dot{H}_i(D_i,H) &= - \frac{2\pi}{V(T) V_{i,\rm comp}(T,p)} D_i^2 \dot{D}_i(D_i,H) \label{eq:Hdot_i} \displaybreak[0] \\
  \frac{\partial \dot{H}_i}{\partial D_i}(D_i,H) &= - \frac{2\pi}{V(T) V_{i,\rm comp}(T,p)} \biggl(2 D_i \dot{D}_i(D_i,H) + D_i^2 \frac{\partial \dot{D}_i}{\partial D_i}(D_i,H)\biggr) \displaybreak[0] \\
  \frac{\partial \dot{H}_i}{\partial H}(D_i,H) &= - \frac{2\pi}{V(T) V_{i,\rm comp}(T,p)} D_i^2 \frac{\partial \dot{D}_i}{\partial H}(D_i,H) \displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 \dot{H}_{\rm env}(D_1,\ldots,D_N,H) &= - \frac{1}{V(T)} \frac{\partial V}{\partial T}(T) \dot{T} H - \frac{1}{V_{\rm comp}(T,p)} \frac{\partial V_{\rm comp}}{\partial T}(T,p) \dot{T} H - \frac{1}{V_{\rm comp}(T,p)} \frac{\partial V_{\rm comp}}{\partial p}(T,p) \dot{p} H\label{eq:Hdot_env} \displaybreak[0] \\
  &= - \frac{1}{P^{\rm 0}(T)} \frac{\partial P^{\rm 0}}{\partial T}(T) \dot{T} H + \frac{H}{p} \dot{p}\displaybreak[0] \\
  \frac{\partial \dot{H}_{\rm env}}{\partial D_i}(D_1,\ldots,D_N,H) &= 0 \displaybreak[0] \\
  \frac{\partial \dot{H}_{\rm env}}{\partial H}(D_1,\ldots,D_N,H) &= - \frac{1}{P^{\rm 0}(T)} \frac{\partial P^{\rm 0}}{\partial T}(T) \dot{T} + \frac{\dot{p}}{p}\displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  H &= \frac{4 m_{\rm w}}{\rho_{\rm w} V(T) V_{\rm comp}(T,p)} \label{eq:H_m_w} \displaybreak[0] \\
  \dot{H}(D_1,\ldots,D_N,H) &= \sum_{i=1}^N \dot{H}_i(D_i,H) + \dot{H}_{\rm env}(D_1,\ldots,D_N,H) \label{eq:Hdot} \displaybreak[0] \\
  \frac{\partial \dot{H}}{\partial D_i}(D_1,\ldots,D_N,H) &= \frac{\partial \dot{H}_i}{\partial D_i}(D_i,H) + \frac{\partial \dot{H}_{\rm env}}{\partial D_i}(D_1,\ldots,D_N,H) \displaybreak[0] \\
  \frac{\partial \dot{H}}{\partial H}(D_1,\ldots,D_N,H) &= \sum_{i=1}^N \frac{\partial \dot{H}_i}{\partial H}(D_i,H) + \frac{\partial \dot{H}_{\rm env}}{\partial H}(D_1,\ldots,D_N,H)
\end{align}

If $D_i < D_{i,\rm dry}$ then we take
\begin{align}
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    h_i(\delta, D_i, H) &= k_{\rm a}'(D_{i,\rm dry}) \delta
  - U V D_{\rm v}'(D_{i,\rm dry}) H \label{eq:h_out_of_range} \displaybreak[0] \\
  \frac{\partial h_i}{\partial \delta}(\delta, D_i, H) &= k_{\rm a}'(D_{i,\rm dry}) \displaybreak[0] \\
  \frac{\partial h_i}{\partial D_i}(\delta, D_i, H) &= 0 \displaybreak[0] \\
  \frac{\partial h_i}{\partial H}(\delta, D_i, H) &= - U V D_{\rm v}'(D_{i,\rm dry}) \displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \delta^*_i(D_i,H) &= \frac{U V D_{\rm v}'(D_{i,\rm dry}) H}{k_{\rm a}'(D_{i,\rm dry})} \displaybreak[0] \\
  \frac{\partial \delta_i^*}{\partial D_i}(D_i,H) &= 0 \displaybreak[0] \\
  \frac{\partial \delta_i^*}{\partial H}(D_i,H) &= \frac{U V D_{\rm v}'(D_{i,\rm dry})}{k_{\rm a}'(D_{i,\rm dry})} \displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \dot{D}_i(D_i, H) &= \frac{k_{\rm a}'(D_{i,\rm dry}) \delta_i^*(D_i,H)}{U D_{i,\rm dry}} \displaybreak[0] \\
  \frac{\partial \dot{D}_i}{\partial D_i}(D_i, H) &= 0 \displaybreak[0] \\
  \frac{\partial \dot{D}_i}{\partial H}(D_i, H) &=
  \frac{k_{\rm a}'(D_{i,\rm dry})}{U D_{i,\rm dry}}
  \frac{\partial \delta_i^*}{\partial H}(D_i, H) \displaybreak[0] \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \dot{H}_i(D_i,H) &= - \frac{2\pi}{V(T) V_{i,\rm comp}(T,p)} D_{i,\rm dry}^2 \dot{D}_i(D_i,H) \displaybreak[0] \\
  \frac{\partial \dot{H}_i}{\partial D_i}(D_i,H) &= - \frac{2\pi}{V(T) V_{i,\rm comp}(T,p)} D_{i,\rm dry}^2 \frac{\partial \dot{D}_i}{\partial D_i}(D_i,H) \displaybreak[0] \\
  \frac{\partial \dot{H}_i}{\partial H}(D_i,H) &= - \frac{2\pi}{V(T) V_{i,\rm comp}(T,p)} D_{i,\rm dry}^2 \frac{\partial \dot{D}_i}{\partial H}(D_i,H)
\end{align}

For equilibriation:
\begin{align}
  g_i(D_i, H) &= h_i(0, D_i, H) \label{eq:g} \\
  &= H - a_{{\rm w},i}(D_i) \exp\biggl(\frac{X}{D_i}\biggr) \displaybreak[0] \\
  \frac{\partial g_i}{\partial D_i}(D_i, H) &= - \frac{\partial a_{{\rm w},i}}{\partial D_i} (D_i) \exp\biggl(\frac{X}{D_i}\biggr) + a_{{\rm w},i}(D_i) \exp\biggl(\frac{X}{D_i}\biggr) \frac{X}{D_i^2}
\end{align}

\section{Block matrix inverses}
\label{sec:block-matr-invers}

To use the implicit SUNDIALS ODE solvers we need to solve $P X = R$
for $P = I - \gamma J$, with $J$ the Jacobian of the vector field and
$\gamma$ a given constant. We have
\begin{align}
  P &= \begin{bmatrix} A & B \\ C & D \end{bmatrix}, \\
\intertext{where}
  A_{ii} &= 1 - \gamma \frac{\partial \dot{D}_i}{\partial D_i} \\
  B_i &= - \gamma \frac{\partial \dot{D}_i}{\partial H} \\
  C_i &= - \gamma \frac{\partial \dot{H}}{\partial D_i} \\
  D &= 1 - \gamma \frac{\partial \dot{H}}{\partial H}.
\end{align}
To solve $P X = R$ we use the block relations
\begin{align}
  \begin{bmatrix} A & B \\ C & D \end{bmatrix}
  \begin{bmatrix} x \\ y \end{bmatrix}
  &=
  \begin{bmatrix} q \\ r \end{bmatrix} \\
  A x + B y &= q \\
  C x + D y &= r \\
  x &= A^{-1} q - A^{-1} B y \label{eq:solve_x} \\
  y &= D^{-1} r - D^{-1} C x \label{eq:solve_y} \\
  (A - B D^{-1} C) x &= q - B D^{-1} r \label{eq:reduced_x} \\
  (D - C A^{-1} B) y &= r - C A^{-1} q. \label{eq:reduced_y}
\end{align}
This is the usual block matrix solution using the Schur
complement. For us, $A$ is $N \times N$, $B$ is $N \times 1$, $C$ is
$1 \times N$, and $D$ is $1 \times 1$, where $N$ is the number of
particles. Also $A$ is diagonal and so trivially invertible, so $D - C
A^{-1} B$ is $1 \times 1$ and easily calculated. We thus use
equation~(\ref{eq:reduced_y}) to solve for $y$, then solve for $x$
with~(\ref{eq:solve_x}).

Note that $A - B D^{-1} C$ is $N \times N$ and dense,
so~(\ref{eq:reduced_x}) is not a good choice. Although because $B
D^{-1} C$ is rank-one, we could cheaply invert it using the
Sherman-Morrison formula. If we have extra environment variables so it
is rank-2 or rank-3 then we would use the more general Woodbury
identity.

\section{Solution strategy}
\label{sec:solution-strategy}

We choose to use $H$ and $D_1,\ldots,D_N$ as the dynamic variables for
the ODE solver. We could use just $D_1,\ldots,D_N$, as $H(t)$ can be
calculated from $H(0)$ and the current values of the diameters. The
advantages of having $H$ be an independent dynamic variable are:
\begin{enumerate}
\item We can check the final water balance at the end of the ODE
  solver run to check that error tolerances are ok.
\item Because $\dot{D}_i$ depends on $H$, if $H$ were merely a
  function of all the other $D_i$ then the Jacobian would be fully
  dense. Ideally one could use just the diagonal (it will dominate)
  but it's unclear how only-approximate Jacobian inverses would
  interact with the rest of the ODE solver. We could also use the fact
  that the dense terms in $J_{ij}$ would be $(\partial \dot{D}_i
  / \partial H) (\partial H / \partial D_j)$, so it's only
  rank-one. $J$ itself would then be the sum of a diagonal matrix with
  this rank-one matrix, so we could use the Sherman-Morrison formula
  to solve the system cheaply.
\item At some point in the future we might want to treat temperature
  as a dynamic variable as well (condensation lowers the temperature,
  which we currently ignore). This might be easier with $H$ and $T$ as
  dynamic variables. On the other hand, it might be possible to
  compute $T$ knowing the total amount of water that is condensed or
  evaporated. Even then, if we have a better updraft model then it
  seems like something will have to be dynamic other than the particle
  diameters.
\end{enumerate}

Having chosen the state $x = (D_1,\ldots,D_N,H)$, we see that
$\dot{x}$ is defined by~(\ref{eq:Ddot}) and~(\ref{eq:Hdot}) (with
components~(\ref{eq:Hdot_i}) and~(\ref{eq:Hdot_env})). The expressions
for $\dot{D}_i$ are given in terms of the functions $\delta_i^*$ which
are defined implicitly by~(\ref{eq:delta_star}) as the zeros of $h_i$
defined in~(\ref{eq:h}).

To compute $\delta_i^*$ we solve~(\ref{eq:delta_star}) using a Newton
loop, which requires $\partial h_i/\partial \delta$. We then use an
implicit integration method to solve the ODE (as it is stiff), which
results in implicit equations. We solve these with another Newton
loop, which requires derivatives with respect to the state variables
$D_i$ and $H$.

The ODE solution will satisfy $D_i \ge D_{i,\rm dry}$, but a numerical
solution may violate this condition. In this case we use the alternate
equations which force the system back towards the allowed region.

\end{document}
